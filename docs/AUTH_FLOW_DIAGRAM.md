# CareConnect Authentication Flow

## ğŸ“‹ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         NEXT.JS APP                              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  Public Routes  â”‚         â”‚ Protected Routes â”‚               â”‚
â”‚  â”‚                â”‚         â”‚                  â”‚               â”‚
â”‚  â”‚  /login        â”‚         â”‚  /dashboard      â”‚               â”‚
â”‚  â”‚  /register     â”‚         â”‚  /appointments   â”‚               â”‚
â”‚  â”‚  /             â”‚         â”‚  /referrals      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  /messages       â”‚               â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                      â–²                           â”‚
â”‚                                      â”‚                           â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                       â”‚    middleware.ts             â”‚           â”‚
â”‚                       â”‚  - Checks auth status        â”‚           â”‚
â”‚                       â”‚  - Redirects if needed       â”‚           â”‚
â”‚                       â”‚  - Refreshes session         â”‚           â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                      â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SUPABASE BACKEND                            â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Auth Service   â”‚         â”‚   PostgreSQL DB  â”‚             â”‚
â”‚  â”‚                  â”‚         â”‚                  â”‚             â”‚
â”‚  â”‚  - User login    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤  - profiles      â”‚             â”‚
â”‚  â”‚  - User signup   â”‚         â”‚  - referrals     â”‚             â”‚
â”‚  â”‚  - Session mgmt  â”‚         â”‚  - appointments  â”‚             â”‚
â”‚  â”‚  - JWT tokens    â”‚         â”‚  - messages      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  - sessions      â”‚             â”‚
â”‚                               â”‚  - audit_logs    â”‚             â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                       â”‚                         â”‚
â”‚                               â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                               â”‚   RLS Policies   â”‚             â”‚
â”‚                               â”‚  - Row security  â”‚             â”‚
â”‚                               â”‚  - Role checking â”‚             â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Registration Flow

```
User fills form                Browser                    Server                   Supabase
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚                         â”‚
     â”‚    1. Submit form           â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚
     â”‚                             â”‚  2. Call register()     â”‚                         â”‚
     â”‚                             â”‚     action              â”‚                         â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                             â”‚                         â”‚  3. Create auth user  â”‚
     â”‚                             â”‚                         â”‚     with metadata     â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                             â”‚                         â”‚  4. Return user ID    â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                             â”‚                         â”‚  5. Insert profile    â”‚
     â”‚                             â”‚                         â”‚     with role         â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                             â”‚                         â”‚  6. Profile created   â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  7. Set auth cookies    â”‚                         â”‚
     â”‚    Redirect to /dashboard   â”‚     & redirect          â”‚                         â”‚
```

## ğŸ” Login Flow

```
User enters credentials        Browser                    Server                   Supabase
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚                         â”‚
     â”‚    1. Submit login form     â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚
     â”‚                             â”‚  2. Call login()        â”‚                         â”‚
     â”‚                             â”‚     action              â”‚                         â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                             â”‚                         â”‚  3. Verify credentialsâ”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                             â”‚                         â”‚  4. Return session    â”‚
     â”‚                             â”‚                         â”‚     & JWT token       â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  5. Set cookies &       â”‚                         â”‚
     â”‚    Redirect to /dashboard   â”‚     redirect            â”‚                         â”‚
```

## ğŸ›¡ï¸ Protected Route Access

```
User visits /dashboard         Middleware                 Supabase                 Page Component
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚                         â”‚
     â”‚    1. Request page          â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚
     â”‚                             â”‚  2. Verify session      â”‚                         â”‚
     â”‚                             â”‚     from cookies        â”‚                         â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
     â”‚                             â”‚  3. Return user info    â”‚                         â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                             â”‚  4. Allow request                                â”‚
     â”‚                             â”‚                                                  â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚    5. Render protected page                                                    â”‚
```

## ğŸš« Unauthorized Access Attempt

```
User (not logged in)           Middleware                 Supabase
     â”‚                             â”‚                         â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚
     â”‚    1. Try /dashboard        â”‚                         â”‚
     â”‚                             â”‚                         â”‚
     â”‚                             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                             â”‚  2. Check session       â”‚
     â”‚                             â”‚                         â”‚
     â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                             â”‚  3. No valid session    â”‚
     â”‚                             â”‚                         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
     â”‚    4. Redirect to /login    â”‚                         â”‚
```

## ğŸ—„ï¸ Database Query with RLS

```
User Query                     Supabase                   RLS Policy                Database
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚                         â”‚
     â”‚  SELECT * FROM referrals    â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚
     â”‚                             â”‚  Check user role        â”‚                         â”‚
     â”‚                             â”‚  & permissions          â”‚                         â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                             â”‚                         â”‚  Filter query based   â”‚
     â”‚                             â”‚                         â”‚  on role              â”‚
     â”‚                             â”‚                         â”‚                         â”‚
     â”‚                             â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Return filtered data â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚                         â”‚
     â”‚  Only see allowed records   â”‚                         â”‚                         â”‚
```

## ğŸ“Š Role-Based Access Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Resource         â”‚ Student  â”‚ PSG Member  â”‚ Admin  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Own Profile        â”‚   R/W    â”‚    R/W      â”‚  R/W   â”‚
â”‚ Other Profiles     â”‚   -      â”‚     R       â”‚  R/W   â”‚
â”‚ Own Referrals      â”‚   R/W    â”‚     -       â”‚  R/W   â”‚
â”‚ Assigned Referrals â”‚   -      â”‚    R/W      â”‚  R/W   â”‚
â”‚ All Referrals      â”‚   -      â”‚     -       â”‚  R/W   â”‚
â”‚ Own Appointments   â”‚   R/W    â”‚     -       â”‚  R/W   â”‚
â”‚ Assigned Appts     â”‚   -      â”‚    R/W      â”‚  R/W   â”‚
â”‚ Messages (sent)    â”‚   R/W    â”‚    R/W      â”‚  R/W   â”‚
â”‚ Messages (others)  â”‚   -      â”‚     -       â”‚  R/W   â”‚
â”‚ Screening Results  â”‚   R/W    â”‚     R       â”‚  R/W   â”‚
â”‚ Session Notes      â”‚   R      â”‚    R/W      â”‚  R/W   â”‚
â”‚ Audit Logs         â”‚   -      â”‚     -       â”‚   R    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend: R = Read, W = Write, - = No Access
```

## ğŸ”‘ Session Management

```
Login                         Session Active              Logout
  â”‚                                 â”‚                        â”‚
  â”‚ 1. User signs in                â”‚                        â”‚
  â”‚                                 â”‚                        â”‚
  â”œâ”€â”€â–º JWT Token Generated          â”‚                        â”‚
  â”‚                                 â”‚                        â”‚
  â”œâ”€â”€â–º Stored in HTTP-only cookie   â”‚                        â”‚
  â”‚                                 â”‚                        â”‚
  â”‚                                 â”‚ 2. Token auto-refresh  â”‚
  â”‚                                 â”‚    on each request     â”‚
  â”‚                                 â”‚                        â”‚
  â”‚                                 â”‚ 3. Middleware verifies â”‚
  â”‚                                 â”‚    token validity      â”‚
  â”‚                                 â”‚                        â”‚
  â”‚                                 â”‚                        â”‚ 4. User clicks logout
  â”‚                                 â”‚                        â”‚
  â”‚                                 â”‚                        â”œâ”€â”€â–º Delete token
  â”‚                                 â”‚                        â”‚
  â”‚                                 â”‚                        â”œâ”€â”€â–º Clear cookies
  â”‚                                 â”‚                        â”‚
  â”‚                                 â”‚                        â””â”€â”€â–º Redirect to /login
```

## ğŸ“ File Responsibilities

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CLIENT SIDE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  src/lib/supabase/client.ts                                 â”‚
â”‚  â””â”€â–º Creates browser Supabase client                        â”‚
â”‚      Used in: Client Components, Hooks, Realtime            â”‚
â”‚                                                              â”‚
â”‚  src/lib/hooks/useAuth.ts                                   â”‚
â”‚  â””â”€â–º React hook for client auth state                       â”‚
â”‚      Returns: user, profile, loading, isAuthenticated       â”‚
â”‚                                                              â”‚
â”‚  src/app/login/page.tsx                                     â”‚
â”‚  â””â”€â–º Client component with form                             â”‚
â”‚      Calls: login() server action                           â”‚
â”‚                                                              â”‚
â”‚  src/app/register/page.tsx                                  â”‚
â”‚  â””â”€â–º Client component with form                             â”‚
â”‚      Calls: register() server action                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SERVER SIDE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  src/lib/supabase/server.ts                                 â”‚
â”‚  â””â”€â–º Creates server Supabase client                         â”‚
â”‚      Used in: Server Components, Server Actions             â”‚
â”‚                                                              â”‚
â”‚  src/lib/actions/auth.ts                                    â”‚
â”‚  â””â”€â–º Server actions for auth                                â”‚
â”‚      Functions: login(), register(), logout(), getUser()    â”‚
â”‚                                                              â”‚
â”‚  src/middleware.ts                                          â”‚
â”‚  â””â”€â–º Route protection & session refresh                     â”‚
â”‚      Runs on: Every request (except static files)           â”‚
â”‚                                                              â”‚
â”‚  src/app/dashboard/page.tsx                                 â”‚
â”‚  â””â”€â–º Server component (protected)                           â”‚
â”‚      Calls: getUser() to verify auth                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     VALIDATION                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  src/lib/validations/auth.ts                                â”‚
â”‚  â””â”€â–º Zod schemas for forms                                  â”‚
â”‚      Schemas: loginSchema, registerSchema                   â”‚
â”‚      Validates: Email format, password strength, etc.       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     UTILITIES                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  src/lib/utils/auth.ts                                      â”‚
â”‚  â””â”€â–º Helper functions                                       â”‚
â”‚      Functions: isStudent(), isPSGMember(), formatRole()    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Key Concepts

### 1. Server vs Client Components

```typescript
// Server Component (default)
export default async function Page() {
  const user = await getUser(); // âœ… Can use async/await
  return <div>{user.name}</div>;
}

// Client Component ('use client' directive)
("use client");
export default function Page() {
  const { user } = useAuth(); // âœ… Can use hooks
  return <div>{user?.name}</div>;
}
```

### 2. RLS (Row Level Security)

```sql
-- Students can only see their own referrals
CREATE POLICY "Students see own referrals"
  ON referrals FOR SELECT
  USING (student_id = auth.uid());

-- PSG members see assigned referrals
CREATE POLICY "PSG see assigned"
  ON referrals FOR SELECT
  USING (
    get_user_role(auth.uid()) = 'psg_member'
    AND assigned_psg_member_id = auth.uid()
  );
```

### 3. Middleware Protection

```typescript
// Automatically protects these routes
const protectedRoutes = [
  "/dashboard",
  "/appointments",
  "/referrals",
  "/messages",
];

// If not authenticated â†’ redirect to /login
// If authenticated on /login â†’ redirect to /dashboard
```

---

**This diagram shows the complete authentication architecture of CareConnect!**
